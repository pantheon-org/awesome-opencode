name: Triage Tool Submission

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write
  contents: read

jobs:
  triage:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'submission')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Load prompt template
        id: load-prompt
        run: |
          PROMPT=$(cat .github/prompts/triage-relevance.md)
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Post OpenCode triage request
        uses: actions/github-script@v7
        env:
          PROMPT_TEMPLATE: ${{ steps.load-prompt.outputs.prompt }}
        with:
          script: |
            const body = context.payload.issue.body;
            const urlMatch = body.match(/https:\/\/github\.com\/[^\s\)]+/);
            
            if (!urlMatch) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ùå **Error**: No GitHub repository URL found in the issue body. Please edit the issue and include a valid GitHub URL.`
              });
              core.setFailed('No GitHub repository URL found in issue body');
              return;
            }
            
            const repoUrl = urlMatch[0];
            
            // Load and populate the prompt template
            const promptTemplate = process.env.PROMPT_TEMPLATE;
            const commentBody = promptTemplate.replace(/\{\{REPO_URL\}\}/g, repoUrl);
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
